# Технологическая(проектно-технологическая) практика

### АВТОРЫ

## Шорников Даниил <br /> Олифиренко Максим <br /> Антипин Демид

## Схема работы

![Схема](images/scheme.svg)

## Satellite Emulator

Этот проект представляет собой симулятор, который эмулирует публикацию данных со спутников.

### Описание

Проект разработан для:

- Тестирования систем обработки данных со спутников.
- Разработки и отладки алгоритмов обработки спутниковых данных.
- Обучения работе с данными со спутников.

### Функциональность

- Генерация данных: С помощью API https://api.simurg.space/datafiles/map_files проект загружает архивные данные со спутника.
- Обработка данных: Архивы распаковываются и разделяются на временные интервалы.
- Публикация данных: Симулируется публикация данных через демонов, которые могут быть реализованы в соответствии с требованиями проекта.

### Установка

1. Клонирование репозитория:

```bash
git clone https://github.com/PUTENCHIK/satellite-emulator.git
cd satellite-emulator
```

2. Установка зависимостей:

```bash
sudo apt install python3.10-venv
sudo python3 -m pip install —upgrade build
sudo python3 -m build
sudo python3 -m pip install .
```


### Запуск

1. Запуск сервера FastAPI:

```bash
python3 app_start.py
```

2. Запуск эмуляции:

- Откройте браузер и перейдите по адресу http://127.0.0.1:8000/start.
- Введите дату в формате YYYY-MM-DD (например, 2023-03-15) в поле date и нажмите "Start".

### APP.py

Этот код представляет собой серверное приложение на базе FastAPI, предназначенное для эмуляции спутниковых данных. Вот краткое описание его функционала:


## Функции

##### WebSocket Endpoint (`/ws`)

Позволяет клиентам подключаться через WebSocket и получать реальные обновления логов в режиме реального времени.

- **Вводные данные**: WebSocket соединение.
- **Данные вывода**: Текстовые сообщения с данными логов.

##### Get Root (`/`)

Отображает главную страницу с пользовательским интерфейсом для взаимодействия с WebSocket.

- **Вводные данные**: Нет.
- **Данные вывода**: HTMLResponse с HTML и JavaScript кодом для открытия WebSocket соединения и отображения данных.

##### Get Date (`/get_date`)

Возвращает текущую установленную дату начала эмуляции.

- **Вводные данные**: Нет.
- **Данные вывода**: JSON объект с текущей датой начала эмуляции.

##### Show Stations (`/show_stations`)

Показывает список всех станций и соответствующие им доступные файлы данных.

- **Вводные данные**: Нет.
- **Данные вывода**: JSON объект со списком станций и доступными файлами.

##### Get Stations (`/get_stations`)

Возвращает список станций, которые были установлены для текущей сессии.

- **Вводные данные**: Нет.
- **Данные вывода**: JSON объект со списком текущих станций.

##### Get Active Services (`/get_active_services`)

Предоставляет список активных системных демонов, связанных со станциями.

- **Вводные данные**: Нет.
- **Данные вывода**: JSON объект со списком активных сервисов.

##### Get Path (`/get_path`)

Возвращает путь к директории, где расположен исполняемый файл приложения.

- **Вводные данные**: Нет.
- **Данные вывода**: JSON объект с путем к директории исполняемого файла.

##### Start Emulation (`/start`)

Запускает процесс эмуляции, подготавливая файлы данных и запуская системные демоны.

- **Вводные данные**: JSON объект `StartEmulation` с датой начала и списком станций.
- **Данные вывода**: JSON объект со статусом 'okay'.

##### Stop Emulation (`/stop`)

Останавливает эмуляцию для указанных станций, останавливая соответствующие системные демоны.

- **Вводные данные**: JSON объект `Stations` со списком станций для остановки.
- **Данные вывода**: JSON объект со статусом 'stopped'.

##### Restart Emulation (`/restart`)

Перезапускает эмуляцию для указанных станций, перезапуская соответствующие системные демоны.

- **Вводные данные**: JSON объект `Stations` со списком станций для перезапуска.
- **Данные вывода**: JSON объект со статусом 'restarted'.

##### Update Date (`/update_date`)

Обновляет дату начала эмуляции на следующий день после текущей установленной даты.

- **Вводные данные**: Нет.
- **Данные вывода**: JSON объект с обновленной датой приложения.

##### Вспомогательные функции

- `get_all_stations()`: Возвращает список всех станций.
- `check_stations(arr: list)`: Проверяет и обновляет глобальный список станций.
- `try_download(i = 1)`: Пытается скачать данные и возвращает булевый результат.

## Запуск

Для запуска приложения используйте следующую команду:

```shell
uvicorn app:app --reload
```
### Main.py

Этот скрипт на Python предназначен для асинхронной загрузки архивов данных по заданной дате и их последующего распаковывания.

##### `get_data(date: str)`

Асинхронная функция, которая загружает данные за указанную дату.

- **Вводные данные**: Строка с датой в формате `YYYY-MM-DD`.
- **Данные для вывода**: Файл архива `.zip`, сохранённый в локальной директории.

##### `unzip(date: str)`

Асинхронная функция, которая распаковывает загруженный архив данных.

- **Вводные данные**: Строка с датой в формате `YYYY-MM-DD`.
- **Данные для вывода**: Распакованные файлы в соответствующей директории.

##### Использование

Для использования скрипта необходимо запустить его из командной строки, передав дату в качестве аргумента:

```shell
python main.py YYYY-MM-DD
```

### Logger.py

Этот код представляет собой класс Logger, который настраивает логирование в Python. Вот краткое описание его функционала:

Форматирование: 

Определяет формат сообщений лога, включая время, имя, уровень логирования и само сообщение.

Файл лога:

Логи записываются в файл logs.log, который находится в двух уровнях выше относительно файла скрипта.

Ротация файлов:

Использует RotatingFileHandler для автоматической ротации логов, ограничивая размер файла до 10 МБ и сохраняя до 5 резервных копий.

Уровень логирования:

Устанавливает глобальный уровень логирования как DEBUG.

Обработчики:

Добавляет обработчик файла и, при необходимости, обработчик консоли для вывода логов.

Методы добавления сообщений: 

Предоставляет методы add_debug, add_info, add_warning, add_error для добавления сообщений соответствующего уровня.

Класс Logger может быть использован для удобного логирования различных событий в приложении, обеспечивая централизованное управление логами и их форматированием. Он также поддерживает ротацию логов, что помогает избежать переполнения дискового пространства из-за больших лог-файлов.

##### Использование

Для использования класса `Logger` необходимо создать экземпляр класса с указанием имени логгера и, при необходимости, включить вывод логов в консоль.

```python
from models import Logger

# Создание экземпляра логгера

my_logger = Logger(name="MyAppLogger", console_out=True)

# Добавление сообщений разного уровня

my_logger.add_debug("Это сообщение уровня DEBUG")
my_logger.add_info("Это информационное сообщение")
my_logger.add_warning("Это предупреждение")
my_logger.add_error("Это сообщение об ошибке")
```

*Обновленный README.md:*

## Publisher.py

Этот файл представляет собой эмулятор спутниковых данных GNSS, предназначенный для тестирования и разработки.

##### Возможности

* *Генерация данных:* Создает реалистичные данные спутниковых данных GNSS на основе различных параметров.
* *Настройка:* Позволяет настраивать имитируемые данные для удовлетворения конкретных требований тестирования.
* *Вывод данных:* Предоставляет возможности вывода данных в различных форматах (например, RINEX).
* *Интеграция:* Может быть интегрирован с другими приложениями, связанными с GNSS, для тестирования и проверки.

##### Использование

1. *Настройте эмулятор:* Измените файл конфигурации (config.py), чтобы установить нужные параметры моделирования.

2. *Запустите эмулятор:*

```Bash
python3 publisher.py <станция>
```

Замените <станция> на имя станции, которую вы хотите смоделировать.

3. *Вывод данных:* Эмулятор будет выводить сгенерированные данные в указанный каталог вывода.

##### tec_to_string(tec)
Эта функция принимает объект tec из библиотеки gnss_tec.rnx, который содержит данные о спутниковой ионосферной задержке (TEC), и преобразует его в строку для удобного представления.
- *Входные данные:* Объект tec из gnss_tec.rnx.
- *Выходные данные:* Строковое представление данных TEC в формате timestamp satellite: phase_tec p_range_tec.

##### read_file(reader)

Эта функция читает данные из объекта reader, полученного из файла RINEX с помощью библиотеки gnss_tec.rnx, и группирует их по секундам.

- *Входные данные:* Объект reader из gnss_tec.rnx.
- *Выходные данные:* Возвращает список объектов tec для каждой секунды данных.

##### rewrite_reader()

Эта функция обновляет глобальную переменную reader (объект reader из gnss_tec.rnx) данными из файла RINEX за следующий день.

- *Входные данные:* Нет.
- *Выходные данные:* Обновляет объект reader данными из файла RINEX за следующий день.

##### main()

Эта функция является главной функцией приложения. Она запускает эмулятор спутниковых данных GNSS.

- *Входные данные:* <станция> - имя станции для моделирования.
- *Выходные данные:* Имитируемые спутниковые данные GNSS, опубликованные на брокере MQTT по теме станция.

### subscriber.py

Этот файл реализует подписчика на сообщения MQTT. Он получает информацию о станциях из API, подписывается на их темы и обрабатывает входящие сообщения.

##### check_client_activity():

* Описание: Проверяет, была ли активность клиента в течение заданного времени.
- *Входные данные:* Нет.
- *Входные данные:* bool - True, если активность была, False - если нет.

##### on_message(client, userdata, message):

* Описание: Обрабатывает входящие сообщения.
- *Входные данные: * 

client: Объект MQTT-клиента.

userdata: Пользовательские данные.

message: Сообщение MQTT.

- *Выходные данные:*

Действия:

Декодирует сообщение.

Записывает полученное сообщение в лог.

Обновляет время последнего сообщения для темы.


##### main (главный код):

Описание: Инициализирует, подключается к брокеру, получает станции, подписывается на темы, обрабатывает сообщения и завершает работу.
